# SpeedCalendar 登录功能部署和使用指南

## 一、项目概述

本项目实现了完整的手机号登录功能，包括：
- 手机号 + 验证码登录
- 自动注册（首次登录自动创建账户）
- JWT Token认证
- 用户信息管理
- 前后端完整集成

## 二、后端部署步骤

### 1. 数据库初始化

#### 1.1 安装MySQL
确保已安装MySQL 8.0+

#### 1.2 执行建表脚本
```bash
# 进入项目目录
cd C:\Users\18241\Desktop\lightningPlan-server\SpeedCalendar-server

# 使用MySQL命令行执行脚本
mysql -u root -p < database_init.sql
```

或者使用MySQL客户端工具（如Navicat、MySQL Workbench）执行`database_init.sql`文件。

#### 1.3 验证数据库创建成功
```sql
USE speed_calendar;
SHOW TABLES;
-- 应该看到: users, verification_codes, user_tokens
```

### 2. 配置后端

#### 2.1 修改application.yml
打开 `src/main/resources/application.yml`，修改数据库密码：

```yaml
spring:
  datasource:
    password: your_mysql_password  # 修改为你的MySQL密码
```

#### 2.2 安装Redis（可选）
如果需要使用Redis缓存，安装Redis并确保运行在localhost:6379。

如果不使用Redis，可以暂时注释掉Redis相关配置。

### 3. 启动后端服务

#### 方法1：使用Maven命令
```bash
cd C:\Users\18241\Desktop\lightningPlan-server\SpeedCalendar-server

# Windows
mvnw.cmd clean spring-boot:run

# Linux/Mac
./mvnw clean spring-boot:run
```

#### 方法2：使用IDE（推荐）
1. 使用IntelliJ IDEA打开项目
2. 找到`SpeedCalendarServerApplication.java`
3. 右键 → Run 'SpeedCalendarServerApplication'

### 4. 验证后端启动成功

访问健康检查接口：
```bash
curl http://localhost:8080/api/auth/health
```

应该返回：
```json
{
  "code": 200,
  "message": "服务正常",
  "data": "SpeedCalendar Auth Service is running"
}
```

## 三、前端部署步骤

### 1. 配置Android项目

#### 1.1 检查Retrofit依赖
确保 `app/build.gradle.kts` 中包含以下依赖：

```kotlin
dependencies {
    // Retrofit
    implementation("com.squareup.retrofit2:retrofit:2.9.0")
    implementation("com.squareup.retrofit2:converter-gson:2.9.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.11.0")

    // ViewModel
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.8.3")
}
```

### 2. 配置网络地址

#### 2.1 修改API地址
打开 `data/api/RetrofitClient.kt`：

**如果使用Android模拟器：**
```kotlin
private const val BASE_URL = "http://10.0.2.2:8080/api/"
```

**如果使用真机：**
```kotlin
private const val BASE_URL = "http://YOUR_PC_IP:8080/api/"
// 例如：http://192.168.1.100:8080/api/
```

#### 2.2 查看本机IP地址
```bash
# Windows
ipconfig

# Mac/Linux
ifconfig
```
找到本机的局域网IP地址（通常是192.168.x.x）。

### 3. 添加网络权限

确保 `AndroidManifest.xml` 中包含：
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

### 4. 运行前端应用

1. 打开Android Studio
2. 同步Gradle（Sync Project with Gradle Files）
3. 连接Android设备或启动模拟器
4. 点击Run按钮

## 四、功能测试

### 1. 发送验证码

#### 1.1 在应用中测试
1. 打开应用
2. 进入"我的"页面
3. 点击登录入口
4. 输入手机号：`13800138000`
5. 点击"发送验证码"

#### 1.2 查看验证码
由于未集成真实短信服务，验证码会打印在后端日志中：

```
【验证码】手机号: 13800138000, 验证码: 123456, 有效期: 300秒
```

在后端控制台中查找这行日志，获取验证码。

### 2. 登录

1. 输入刚才收到的验证码
2. 勾选"用户协议"复选框
3. 点击"登录"按钮
4. 登录成功后自动关闭登录页面

### 3. 验证登录状态

登录成功后，用户信息会保存在SharedPreferences中，下次打开应用会自动保持登录状态。

## 五、API接口文档

### 1. 发送验证码
```
POST /api/auth/code

请求体：
{
  "phone": "13800138000"
}

成功响应：
{
  "code": 200,
  "message": "验证码发送成功",
  "data": null
}
```

### 2. 手机号登录
```
POST /api/auth/login/phone

请求体：
{
  "phone": "13800138000",
  "code": "123456"
}

成功响应：
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": "user-uuid",
    "token": "jwt-access-token",
    "refreshToken": "jwt-refresh-token",
    "expiresIn": 7200,
    "userInfo": {
      "userId": "user-uuid",
      "phone": "13800138000",
      "username": "用户8000",
      "avatar": "https://api.dicebear.com/7.x/initials/svg?seed=用户8000",
      "loginType": "phone",
      "createdAt": "2025-11-16T10:00:00"
    }
  }
}
```

## 六、常见问题

### 1. 后端启动失败

#### 问题：数据库连接失败
**解决方案：**
- 检查MySQL是否启动
- 检查application.yml中的数据库密码
- 确认数据库名称为`speed_calendar`

#### 问题：端口8080被占用
**解决方案：**
修改application.yml中的端口号：
```yaml
server:
  port: 8081  # 改为其他端口
```

### 2. 前端网络请求失败

#### 问题：网络连接失败
**解决方案：**
1. 确认后端服务已启动
2. 检查RetrofitClient.kt中的BASE_URL配置
3. 真机测试时，确保手机和电脑在同一局域网
4. 检查防火墙设置，允许8080端口访问

#### 问题：收不到验证码
**解决方案：**
- 验证码会打印在后端控制台日志中
- 查找包含"【验证码】"的日志行
- 或者直接使用`123456`作为测试验证码（需修改代码）

### 3. 登录后立即退出

**解决方案：**
- 检查SharedPreferences是否正常保存
- 查看AuthViewModel的日志输出
- 确认Token保存成功

## 七、生产环境部署建议

### 1. 安全配置

#### 1.1 修改JWT密钥
```yaml
jwt:
  secret: your-production-secret-key-must-be-very-long-and-random
```

#### 1.2 集成真实短信服务
修改`AuthService.java`中的sendVerificationCode方法：
```java
// 集成阿里云短信服务
SmsService smsService = new AliyunSmsService();
smsService.sendCode(phone, code);
```

### 2. 数据库优化

- 定期清理过期的验证码和Token
- 添加数据库索引优化查询性能
- 配置数据库备份策略

### 3. 服务器配置

- 使用Nginx反向代理
- 配置HTTPS证书
- 限制API请求频率
- 添加日志监控和告警

## 八、项目结构总结

### 后端结构
```
SpeedCalendar-server/
├── entity/              # 实体类（User, VerificationCode, UserToken）
├── dto/                 # 数据传输对象（请求、响应）
├── repository/          # 数据访问层
├── service/             # 业务逻辑层（AuthService）
├── controller/          # API控制层（AuthController）
├── util/                # 工具类（JwtUtil, IpUtil）
└── config/              # 配置类（BcryptConfig）
```

### 前端结构
```
SpeedCalendar/
├── data/
│   ├── model/           # 数据模型
│   ├── api/             # API服务（RetrofitClient, AuthApiService）
│   └── local/           # 本地存储（UserPreferences）
├── viewmodel/           # 视图模型（AuthViewModel）
└── features/mine/       # 登录页面（LoginSheet）
```

## 九、下一步开发建议

1. 实现日程管理功能（参考旧版本）
2. 添加AI对话功能
3. 实现Token刷新机制
4. 添加邮箱登录功能
5. 实现用户信息修改
6. 添加头像上传功能
7. 完善错误处理和重试机制

---

**开发团队：** SpeedCalendar Team
**文档版本：** 1.0
**更新日期：** 2025-11-16
